<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waverless Monitoring - Metrics</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }

        /* 顶部导航 */
        .nav-tabs {
            background: white;
            border-bottom: 1px solid #e1e8ed;
            padding: 0 30px;
            display: flex;
            gap: 40px;
        }

        .nav-tab {
            padding: 18px 0;
            cursor: pointer;
            color: #657786;
            font-size: 15px;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: #1da1f2;
        }

        .nav-tab.active {
            color: #1da1f2;
            border-bottom-color: #1da1f2;
        }

        /* 控制栏 */
        .controls-bar {
            background: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e1e8ed;
        }

        .controls-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .date-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
        }

        .date-picker:hover {
            border-color: #1da1f2;
        }

        .date-picker i {
            color: #6b7280;
        }

        .time-range-select {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            outline: none;
        }

        .time-range-select:hover {
            border-color: #1da1f2;
        }

        .live-data-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
        }

        .live-data-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .controls-right {
            display: flex;
            gap: 10px;
        }

        .view-toggle {
            display: flex;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            overflow: hidden;
        }

        .view-toggle button {
            padding: 8px 16px;
            border: none;
            background: white;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
        }

        .view-toggle button:hover {
            background: #f3f4f6;
        }

        .view-toggle button.active {
            background: #1da1f2;
            color: white;
        }

        /* 主内容区 */
        .main-content {
            padding: 30px;
        }

        /* 图表网格 */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .chart-total {
            font-size: 13px;
            color: #6b7280;
        }

        .chart-total span {
            font-weight: 600;
            color: #1f2937;
        }

        .chart-legend {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.completed {
            background: #48bb78;
        }

        .legend-dot.failed {
            background: #f56565;
        }

        .legend-dot.retried {
            background: #ecc94b;
        }

        .chart-container {
            height: 280px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* 加载动画 */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1da1f2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 快捷时间选择 */
        .quick-ranges {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px;
            display: none;
            z-index: 100;
            min-width: 200px;
        }

        .quick-ranges.show {
            display: block;
        }

        .quick-range-item {
            padding: 10px 16px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            color: #374151;
        }

        .quick-range-item:hover {
            background: #f3f4f6;
        }

        .date-picker-wrapper {
            position: relative;
        }
    </style>
</head>
<body>
    <!-- 导航标签 -->
    <div class="nav-tabs">
        <div class="nav-tab">Overview</div>
        <div class="nav-tab active">Metrics</div>
        <div class="nav-tab">Logs</div>
        <div class="nav-tab">Requests</div>
        <div class="nav-tab">Workers</div>
        <div class="nav-tab">Releases</div>
    </div>

    <!-- 控制栏 -->
    <div class="controls-bar">
        <div class="controls-left">
            <!-- 日期选择器 -->
            <div class="date-picker-wrapper">
                <div class="date-picker" id="datePickerBtn">
                    <i class="far fa-calendar"></i>
                    <span id="dateRangeText">12月 7, 2025 → 1月 5, 2026</span>
                </div>
                <div class="quick-ranges" id="quickRanges">
                    <div class="quick-range-item" data-range="1h">最近 1 小时</div>
                    <div class="quick-range-item" data-range="6h">最近 6 小时</div>
                    <div class="quick-range-item" data-range="24h">最近 24 小时</div>
                    <div class="quick-range-item" data-range="7d">最近 7 天</div>
                    <div class="quick-range-item" data-range="30d">最近 30 天</div>
                </div>
            </div>

            <!-- 时间粒度选择 -->
            <select class="time-range-select" id="granularitySelect">
                <option value="1min">1 分钟</option>
                <option value="5min">5 分钟</option>
                <option value="15min">15 分钟</option>
                <option value="1hour" selected>1 小时</option>
                <option value="1day">1 天</option>
            </select>

            <!-- 实时数据切换 -->
            <label class="live-data-toggle">
                <input type="checkbox" id="liveDataToggle">
                <i class="fas fa-circle" style="color: #48bb78; font-size: 10px;"></i>
                <span>View live data</span>
            </label>
        </div>

        <div class="controls-right">
            <!-- 视图切换 -->
            <div class="view-toggle">
                <button class="active" id="gridViewBtn">
                    <i class="fas fa-th"></i>
                </button>
                <button id="listViewBtn">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 主内容 -->
    <div class="main-content">
        <div class="charts-grid" id="chartsGrid">
            <!-- Requests Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Requests</div>
                    <div class="chart-total">Total: <span id="requestsTotal">54,717</span></div>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-dot completed"></div>
                        <span>Completed: <strong id="completedCount">54,678</strong></span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot failed"></div>
                        <span>Failed: <strong id="failedCount">39</strong></span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot retried"></div>
                        <span>Retried: <strong id="retriedCount">11</strong></span>
                    </div>
                </div>
                <div class="chart-container" id="requestsChart"></div>
            </div>

            <!-- Execution Time Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Execution Time</div>
                    <div class="chart-total">Total: <span id="executionTotal">4d</span></div>
                </div>
                <div class="chart-container" id="executionTimeChart"></div>
            </div>

            <!-- Delay Time Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Delay Time</div>
                    <div class="chart-total">Total: <span id="delayTotal">2d</span></div>
                </div>
                <div class="chart-container" id="delayTimeChart"></div>
            </div>

            <!-- Cold Start Count Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Cold Start Count</div>
                    <div class="chart-total">Total: <span id="coldStartCountTotal">50,602</span></div>
                </div>
                <div class="chart-container" id="coldStartCountChart"></div>
            </div>

            <!-- Cold Start Time Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Cold Start Time</div>
                    <div class="chart-total">Total: <span id="coldStartTimeTotal">23h</span></div>
                </div>
                <div class="chart-container" id="coldStartTimeChart"></div>
            </div>

            <!-- Webhook Request Responses Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Webhook Request Responses</div>
                    <div class="chart-total">Total: <span id="webhookTotal">54,732</span></div>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #48bb78;"></div>
                        <span>2xx: <strong>54,715</strong></span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #a0aec0;"></div>
                        <span>0xx: <strong>17</strong></span>
                    </div>
                </div>
                <div class="chart-container" id="webhookChart"></div>
            </div>

            <!-- Worker Count Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Worker Count</div>
                    <div class="chart-total">Avg: <span id="workerAvg">8.5</span></div>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #3b82f6;"></div>
                        <span>Active Workers</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #94a3b8;"></div>
                        <span>Idle Workers</span>
                    </div>
                </div>
                <div class="chart-container" id="workerCountChart"></div>
            </div>

            <!-- Worker Utilization Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Worker Utilization</div>
                    <div class="chart-total">Avg: <span id="utilizationAvg">76.3%</span></div>
                </div>
                <div class="chart-container" id="workerUtilizationChart"></div>
            </div>

            <!-- Worker Idle Time Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Worker Idle Time (Average)</div>
                    <div class="chart-total">Total: <span id="idleTimeTotal">12.5h</span></div>
                </div>
                <div class="chart-container" id="workerIdleTimeChart"></div>
            </div>

            <!-- Worker Idle Count Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Worker Idle Frequency</div>
                    <div class="chart-total">Total: <span id="idleCountTotal">1,245</span></div>
                </div>
                <div class="chart-container" id="workerIdleCountChart"></div>
            </div>

            <!-- GPU Utilization Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">GPU Utilization</div>
                    <div class="chart-total">Avg: <span id="gpuUtilAvg">82.4%</span></div>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #8b5cf6;"></div>
                        <span>Average GPU Usage</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #f59e0b;"></div>
                        <span>Peak GPU Usage</span>
                    </div>
                </div>
                <div class="chart-container" id="gpuUtilizationChart"></div>
            </div>

            <!-- Worker Lifecycle Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Worker Lifecycle Events</div>
                    <div class="chart-total">Total: <span id="lifecycleTotal">456</span></div>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #48bb78;"></div>
                        <span>Created</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #f56565;"></div>
                        <span>Terminated</span>
                    </div>
                </div>
                <div class="chart-container" id="workerLifecycleChart"></div>
            </div>
        </div>
    </div>

    <!-- 加载动画 -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <script>
        // 全局变量
        let charts = {};
        let currentRange = '7d';
        let currentGranularity = '1hour';
        let liveDataEnabled = false;
        let updateInterval = null;

        // 生成时间序列数据
        function generateTimeSeriesData(hours = 168) {
            const now = new Date();
            const timestamps = [];
            const requests = [];
            const completed = [];
            const failed = [];
            const retried = [];
            const executionP50 = [];
            const executionP95 = [];
            const delay = [];
            const coldStartCount = [];
            const coldStartTime = [];
            const webhook2xx = [];
            const webhook0xx = [];

            // Worker 相关数据
            const activeWorkers = [];
            const idleWorkers = [];
            const workerUtilization = [];
            const avgIdleTime = [];
            const maxIdleTime = [];
            const idleCount = [];
            const gpuUtilAvg = [];
            const gpuUtilPeak = [];
            const workerCreated = [];
            const workerTerminated = [];

            for (let i = hours - 1; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 3600000);
                const hour = date.getHours();

                // 模拟峰值时段（9:00-18:00）
                const isPeak = hour >= 9 && hour <= 18;
                const baseMultiplier = isPeak ? 1.5 : 0.8;

                timestamps.push(date);

                // Requests 数据
                const totalReq = Math.floor((200 + Math.random() * 400) * baseMultiplier);
                const failedReq = Math.floor(totalReq * (0.001 + Math.random() * 0.002));
                const retriedReq = Math.floor(failedReq * 0.3);
                const completedReq = totalReq - failedReq;

                requests.push(totalReq);
                completed.push(completedReq);
                failed.push(failedReq);
                retried.push(retriedReq);

                // Execution Time (ms)
                executionP50.push(8000 + Math.random() * 4000);
                executionP95.push(15000 + Math.random() * 10000);

                // Delay Time (ms) - 大部分时间很低，偶尔有峰值
                const hasSpike = Math.random() > 0.95;
                delay.push(hasSpike ? 15000 + Math.random() * 10000 : 100 + Math.random() * 500);

                // Cold Start Count
                coldStartCount.push(Math.floor((100 + Math.random() * 200) * baseMultiplier));

                // Cold Start Time (seconds)
                coldStartTime.push(30 + Math.random() * 30);

                // Webhook Responses
                webhook2xx.push(completedReq);
                webhook0xx.push(Math.floor(Math.random() * 3));

                // Worker Count - 峰值时段更多 active workers
                const totalWorkers = Math.floor(8 + Math.random() * 6);
                const active = Math.floor(totalWorkers * (isPeak ? 0.7 : 0.4) + Math.random() * 2);
                const idle = totalWorkers - active;

                activeWorkers.push(active);
                idleWorkers.push(idle);

                // Worker Utilization (%) - 峰值时段利用率更高
                workerUtilization.push((isPeak ? 70 : 50) + Math.random() * 20);

                // Worker Idle Time (seconds) - 峰值时段空闲时间更短
                avgIdleTime.push((isPeak ? 60 : 180) + Math.random() * 120);
                maxIdleTime.push((isPeak ? 300 : 600) + Math.random() * 300);

                // Idle Count - 空闲次数
                idleCount.push(Math.floor((isPeak ? 5 : 10) + Math.random() * 10));

                // GPU Utilization (%) - 峰值时段 GPU 使用率更高
                gpuUtilAvg.push((isPeak ? 75 : 60) + Math.random() * 15);
                gpuUtilPeak.push((isPeak ? 85 : 75) + Math.random() * 12);

                // Worker Lifecycle Events
                workerCreated.push(Math.floor(Math.random() * 3));
                workerTerminated.push(Math.floor(Math.random() * 2));
            }

            return {
                timestamps,
                requests,
                completed,
                failed,
                retried,
                executionP50,
                executionP95,
                delay,
                coldStartCount,
                coldStartTime,
                webhook2xx,
                webhook0xx,
                activeWorkers,
                idleWorkers,
                workerUtilization,
                avgIdleTime,
                maxIdleTime,
                idleCount,
                gpuUtilAvg,
                gpuUtilPeak,
                workerCreated,
                workerTerminated
            };
        }

        // 格式化时间
        function formatTime(date, granularity) {
            const hour = date.getHours().toString().padStart(2, '0');
            const minute = date.getMinutes().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');

            if (granularity === '1hour' || granularity === '15min' || granularity === '5min' || granularity === '1min') {
                return `${hour}:${minute}`;
            } else if (granularity === '1day') {
                return `${month}-${day}`;
            }
            return `${month}-${day} ${hour}:${minute}`;
        }

        // 初始化图表
        function initCharts() {
            const data = generateTimeSeriesData(168); // 7天数据，按小时
            const timeLabels = data.timestamps.map(t => formatTime(t, currentGranularity));

            // 1. Requests Chart (堆叠柱状图)
            charts.requests = echarts.init(document.getElementById('requestsChart'));
            charts.requests.setOption({
                grid: { left: 50, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                series: [
                    {
                        name: 'Completed',
                        type: 'bar',
                        stack: 'total',
                        data: data.completed,
                        itemStyle: { color: '#48bb78' },
                        barMaxWidth: 10
                    },
                    {
                        name: 'Failed',
                        type: 'bar',
                        stack: 'total',
                        data: data.failed,
                        itemStyle: { color: '#f56565' },
                        barMaxWidth: 10
                    },
                    {
                        name: 'Retried',
                        type: 'bar',
                        stack: 'total',
                        data: data.retried,
                        itemStyle: { color: '#ecc94b' },
                        barMaxWidth: 10
                    }
                ]
            });

            // 2. Execution Time Chart (面积图)
            charts.executionTime = echarts.init(document.getElementById('executionTimeChart'));
            charts.executionTime.setOption({
                grid: { left: 50, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        fontSize: 11,
                        color: '#6b7280',
                        formatter: (value) => (value / 1000).toFixed(0) + 's'
                    }
                },
                series: [
                    {
                        name: 'P95',
                        type: 'line',
                        data: data.executionP95,
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { width: 1, color: '#f56565' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(245, 101, 101, 0.3)' },
                                { offset: 1, color: 'rgba(245, 101, 101, 0.05)' }
                            ])
                        }
                    },
                    {
                        name: 'P50',
                        type: 'line',
                        data: data.executionP50,
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { width: 1, color: '#3b82f6' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(59, 130, 246, 0.3)' },
                                { offset: 1, color: 'rgba(59, 130, 246, 0.05)' }
                            ])
                        }
                    }
                ]
            });

            // 3. Delay Time Chart
            charts.delayTime = echarts.init(document.getElementById('delayTimeChart'));
            charts.delayTime.setOption({
                grid: { left: 50, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        fontSize: 11,
                        color: '#6b7280',
                        formatter: (value) => (value / 1000).toFixed(0) + 's'
                    }
                },
                series: [{
                    name: 'Delay',
                    type: 'bar',
                    data: data.delay,
                    itemStyle: { color: '#f56565' },
                    barMaxWidth: 8
                }]
            });

            // 4. Cold Start Count Chart
            charts.coldStartCount = echarts.init(document.getElementById('coldStartCountChart'));
            charts.coldStartCount.setOption({
                grid: { left: 50, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                series: [{
                    name: 'Count',
                    type: 'bar',
                    data: data.coldStartCount,
                    itemStyle: { color: '#8b5cf6' },
                    barMaxWidth: 8
                }]
            });

            // 5. Cold Start Time Chart
            charts.coldStartTime = echarts.init(document.getElementById('coldStartTimeChart'));
            charts.coldStartTime.setOption({
                grid: { left: 50, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        fontSize: 11,
                        color: '#6b7280',
                        formatter: (value) => value.toFixed(0) + 's'
                    }
                },
                series: [{
                    name: 'Time',
                    type: 'bar',
                    data: data.coldStartTime,
                    itemStyle: { color: '#06b6d4' },
                    barMaxWidth: 8
                }]
            });

            // 6. Webhook Chart
            charts.webhook = echarts.init(document.getElementById('webhookChart'));
            charts.webhook.setOption({
                grid: { left: 50, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                series: [
                    {
                        name: '2xx',
                        type: 'bar',
                        stack: 'total',
                        data: data.webhook2xx,
                        itemStyle: { color: '#48bb78' },
                        barMaxWidth: 10
                    },
                    {
                        name: '0xx',
                        type: 'bar',
                        stack: 'total',
                        data: data.webhook0xx,
                        itemStyle: { color: '#a0aec0' },
                        barMaxWidth: 10
                    }
                ]
            });

            // 7. Worker Count Chart (堆叠面积图)
            charts.workerCount = echarts.init(document.getElementById('workerCountChart'));
            charts.workerCount.setOption({
                grid: { left: 50, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                series: [
                    {
                        name: 'Active Workers',
                        type: 'line',
                        stack: 'total',
                        data: data.activeWorkers,
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { width: 0 },
                        areaStyle: { color: '#3b82f6', opacity: 0.7 }
                    },
                    {
                        name: 'Idle Workers',
                        type: 'line',
                        stack: 'total',
                        data: data.idleWorkers,
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { width: 0 },
                        areaStyle: { color: '#94a3b8', opacity: 0.7 }
                    }
                ]
            });

            // 8. Worker Utilization Chart (面积图)
            charts.workerUtilization = echarts.init(document.getElementById('workerUtilizationChart'));
            charts.workerUtilization.setOption({
                grid: { left: 50, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLabel: {
                        fontSize: 11,
                        color: '#6b7280',
                        formatter: (value) => value + '%'
                    }
                },
                series: [{
                    name: 'Utilization',
                    type: 'line',
                    data: data.workerUtilization,
                    smooth: true,
                    symbol: 'none',
                    lineStyle: { width: 2, color: '#10b981' },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(16, 185, 129, 0.4)' },
                            { offset: 1, color: 'rgba(16, 185, 129, 0.05)' }
                        ])
                    }
                }]
            });

            // 9. Worker Idle Time Chart (柱状图)
            charts.workerIdleTime = echarts.init(document.getElementById('workerIdleTimeChart'));
            charts.workerIdleTime.setOption({
                grid: { left: 50, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        fontSize: 11,
                        color: '#6b7280',
                        formatter: (value) => (value / 60).toFixed(0) + 'm'
                    }
                },
                series: [{
                    name: 'Avg Idle Time',
                    type: 'bar',
                    data: data.avgIdleTime,
                    itemStyle: { color: '#f59e0b' },
                    barMaxWidth: 8
                }]
            });

            // 10. Worker Idle Count Chart (柱状图)
            charts.workerIdleCount = echarts.init(document.getElementById('workerIdleCountChart'));
            charts.workerIdleCount.setOption({
                grid: { left: 50, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                series: [{
                    name: 'Idle Count',
                    type: 'bar',
                    data: data.idleCount,
                    itemStyle: { color: '#ec4899' },
                    barMaxWidth: 8
                }]
            });

            // 11. GPU Utilization Chart (双线图)
            charts.gpuUtilization = echarts.init(document.getElementById('gpuUtilizationChart'));
            charts.gpuUtilization.setOption({
                grid: { left: 50, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLabel: {
                        fontSize: 11,
                        color: '#6b7280',
                        formatter: (value) => value + '%'
                    }
                },
                series: [
                    {
                        name: 'Average',
                        type: 'line',
                        data: data.gpuUtilAvg,
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { width: 2, color: '#8b5cf6' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(139, 92, 246, 0.3)' },
                                { offset: 1, color: 'rgba(139, 92, 246, 0.05)' }
                            ])
                        }
                    },
                    {
                        name: 'Peak',
                        type: 'line',
                        data: data.gpuUtilPeak,
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { width: 1, color: '#f59e0b', type: 'dashed' }
                    }
                ]
            });

            // 12. Worker Lifecycle Chart (堆叠柱状图)
            charts.workerLifecycle = echarts.init(document.getElementById('workerLifecycleChart'));
            charts.workerLifecycle.setOption({
                grid: { left: 50, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                xAxis: {
                    type: 'category',
                    data: timeLabels,
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { fontSize: 11, color: '#6b7280' }
                },
                series: [
                    {
                        name: 'Created',
                        type: 'bar',
                        data: data.workerCreated,
                        itemStyle: { color: '#48bb78' },
                        barMaxWidth: 10
                    },
                    {
                        name: 'Terminated',
                        type: 'bar',
                        data: data.workerTerminated,
                        itemStyle: { color: '#f56565' },
                        barMaxWidth: 10
                    }
                ]
            });

            // 更新统计数字
            updateStatistics(data);
        }

        // 更新统计数字
        function updateStatistics(data) {
            const totalRequests = data.requests.reduce((a, b) => a + b, 0);
            const totalCompleted = data.completed.reduce((a, b) => a + b, 0);
            const totalFailed = data.failed.reduce((a, b) => a + b, 0);
            const totalRetried = data.retried.reduce((a, b) => a + b, 0);
            const totalColdStarts = data.coldStartCount.reduce((a, b) => a + b, 0);

            // Worker 相关统计
            const avgActiveWorkers = (data.activeWorkers.reduce((a, b) => a + b, 0) / data.activeWorkers.length).toFixed(1);
            const avgIdleWorkers = (data.idleWorkers.reduce((a, b) => a + b, 0) / data.idleWorkers.length).toFixed(1);
            const avgWorkerCount = (parseFloat(avgActiveWorkers) + parseFloat(avgIdleWorkers)).toFixed(1);
            const avgUtilization = (data.workerUtilization.reduce((a, b) => a + b, 0) / data.workerUtilization.length).toFixed(1);
            const totalIdleTime = data.avgIdleTime.reduce((a, b) => a + b, 0);
            const totalIdleCount = data.idleCount.reduce((a, b) => a + b, 0);
            const avgGpuUtil = (data.gpuUtilAvg.reduce((a, b) => a + b, 0) / data.gpuUtilAvg.length).toFixed(1);
            const totalLifecycle = data.workerCreated.reduce((a, b) => a + b, 0) + data.workerTerminated.reduce((a, b) => a + b, 0);

            document.getElementById('requestsTotal').textContent = totalRequests.toLocaleString();
            document.getElementById('completedCount').textContent = totalCompleted.toLocaleString();
            document.getElementById('failedCount').textContent = totalFailed.toLocaleString();
            document.getElementById('retriedCount').textContent = totalRetried.toLocaleString();
            document.getElementById('coldStartCountTotal').textContent = totalColdStarts.toLocaleString();

            // 更新 Worker 相关统计
            document.getElementById('workerAvg').textContent = avgWorkerCount;
            document.getElementById('utilizationAvg').textContent = avgUtilization + '%';
            document.getElementById('idleTimeTotal').textContent = (totalIdleTime / 3600).toFixed(1) + 'h';
            document.getElementById('idleCountTotal').textContent = totalIdleCount.toLocaleString();
            document.getElementById('gpuUtilAvg').textContent = avgGpuUtil + '%';
            document.getElementById('lifecycleTotal').textContent = totalLifecycle.toLocaleString();
        }

        // 刷新数据
        function refreshData() {
            document.getElementById('loading').classList.add('active');

            setTimeout(() => {
                initCharts();
                document.getElementById('loading').classList.remove('active');
            }, 500);
        }

        // 时间范围选择
        document.getElementById('datePickerBtn').addEventListener('click', function() {
            document.getElementById('quickRanges').classList.toggle('show');
        });

        document.querySelectorAll('.quick-range-item').forEach(item => {
            item.addEventListener('click', function() {
                currentRange = this.dataset.range;
                const rangeText = this.textContent;

                // 计算日期范围
                const now = new Date();
                let startDate = new Date();

                switch(currentRange) {
                    case '1h': startDate.setHours(now.getHours() - 1); break;
                    case '6h': startDate.setHours(now.getHours() - 6); break;
                    case '24h': startDate.setDate(now.getDate() - 1); break;
                    case '7d': startDate.setDate(now.getDate() - 7); break;
                    case '30d': startDate.setDate(now.getDate() - 30); break;
                }

                const formatDate = (d) => {
                    return `${d.getMonth() + 1}月 ${d.getDate()}, ${d.getFullYear()}`;
                };

                document.getElementById('dateRangeText').textContent =
                    `${formatDate(startDate)} → ${formatDate(now)}`;
                document.getElementById('quickRanges').classList.remove('show');

                refreshData();
            });
        });

        // 时间粒度选择
        document.getElementById('granularitySelect').addEventListener('change', function() {
            currentGranularity = this.value;
            refreshData();
        });

        // 实时数据切换
        document.getElementById('liveDataToggle').addEventListener('change', function() {
            liveDataEnabled = this.checked;

            if (liveDataEnabled) {
                updateInterval = setInterval(refreshData, 5000); // 每5秒刷新
            } else {
                if (updateInterval) {
                    clearInterval(updateInterval);
                }
            }
        });

        // 视图切换
        document.getElementById('gridViewBtn').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('listViewBtn').classList.remove('active');
            document.getElementById('chartsGrid').style.gridTemplateColumns = 'repeat(2, 1fr)';
        });

        document.getElementById('listViewBtn').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('gridViewBtn').classList.remove('active');
            document.getElementById('chartsGrid').style.gridTemplateColumns = '1fr';
        });

        // 点击外部关闭下拉菜单
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.date-picker-wrapper')) {
                document.getElementById('quickRanges').classList.remove('show');
            }
        });

        // 响应式处理
        window.addEventListener('resize', () => {
            Object.values(charts).forEach(chart => chart.resize());
        });

        // 初始化
        initCharts();
    </script>
</body>
</html>
